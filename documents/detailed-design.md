# 映画館窓口業務 MCP サーバ 詳細設計書（Azure Functions Python v2）

## 1. 概要

本ドキュメントは、映画館の窓口業務を支援する MCP サーバのアーキテクチャ、要件、API・インタフェース仕様、データ設計、Azure Functions 実装、拡張性、セキュリティについて詳細に記述します。MCPおよびAzureのベストプラクティスに従い、Python v2プログラミングモデルで構築します。

## 2. 業務要件

- 映画検索、上映スケジュール照会、座席予約、あいまい入力対応、レコメンド、エラー報告をサポート。
- 映画・スケジュール・座席・予約・ユーザー操作のリアルなサンプルデータを提供。
- すべての操作は MCP 準拠の JSON-RPC API で公開。

## 3. システム構成

- **Azure Functions (Python v2):** 各 MCP ツールごとにステートレスな HTTP トリガー関数。
- **データ保存:** Azure Blob Storage の `movies` コンテナ配下の JSON ファイル（映画、スケジュール、座席、予約など）を読み書き。
- **IaC:** Bicep テンプレート（`infra/`）によるプロビジョニング、`azd` で管理。
- **バインディング:** HTTP 入出力バインディングを優先。必要に応じて Azure SDK。

## 4. API・インタフェース設計

- **エンドポイント:** 各 MCP ツールは専用の HTTP トリガー関数にマッピング。
- **リクエスト/レスポンス:** `interface-definition.md`・`tool-mcp-sample.json` で定義された JSON-RPC 形式。
- **エラー処理:** `error.json` に準拠した標準化エラーオブジェクト。
- **サンプルデータ:** `test-data-sample.json` や個別 API データファイルで網羅。

## 5. データ設計

- **映画:** 8本の日本映画、メタデータ付き（`movies.json`）。
- **スケジュール:** 5日間×8作品、1日3～4回上映、スクリーン番号多様（`schedules.json`）。
- **座席:** 1上映16席、予約/空席状態（`seats_schedules.json`）。
- **予約:** 構造定義済み、サンプルは要件により省略。
- **あいまい入力・レコメンド・ユーザー操作:** NLP・パーソナライズ用サンプル。
- **エラー:** クライアント堅牢化用の代表的エラーケース。

## 6. Azure Functions 実装

- **プロジェクト構成:** コードは `src/`、設定は `local.settings.json`・`host.json`。
- **Function App:** MCPツールごとにPython関数（v2デコレータ利用）。
- **バインディング:** HTTPトリガー/出力、API仕様に沿ったルート。
- **ローカル開発:** Azure Functions Core Tools（`func`）でサンプルデータ利用可能。
- **デプロイ:** `azd`・Bicepで自動化、環境変数は `.azure/` で管理。

## 7. 拡張性

- **ツール/API追加:** `tool-mcp-sample.json` で MCP ツール定義、インタフェース・サンプルデータ更新、新関数実装。
- **データ拡張:** 新規サンプルデータ追加や既存拡張で映画・スケジュール・機能増強。
- **連携:** MCPクライアントツールやAzureサービスとの統合容易。

## 8. セキュリティ

- **認証/認可:** Azure Function App設定・Bicep RBACで有効化可能。
- **データ保護:** 機微情報（予約等）は安全に管理。サンプルデータは非機微。
- **エラー処理:** 情報漏洩防止の標準化エラー応答。

## 9. 参考資料

- `business-requirements.md`: 業務要件・データ構造。
- `interface-spec.md`, `interface-definition.md`: APIエンドポイント・フォーマット・エラー処理。
- `tool-mcp-sample.json`: MCPツール定義。
- `test-data-sample.json`, `src/data/`: サンプルデータ。
- Azure Functions Python v2 ドキュメント。
- MCPプロトコルドキュメント。

---

## 10. 機能ごとの処理フロー

各機能の処理フローは以下の通りです。

### 1. 映画検索

**フロー:**
1. MCPクライアントが検索条件（ジャンル、タイトル等）をJSON-RPCリクエストで送信。
2. Azure FunctionがHTTPリクエストを受信し、パラメータを解析。
3. Azure Blob Storage の `movies` コンテナから `movies.json` をロード。
4. 条件で映画をフィルタ。
5. 該当映画をJSON-RPCレスポンスで返却。

**エラー処理:**
- 該当映画なしの場合は空リスト返却。
- パラメータ不正時は標準化エラー返却。

---

### 2. スケジュール照会

**フロー:**
1. MCPクライアントが映画IDや日付でスケジュール照会リクエスト送信。
2. Azure Functionがリクエスト受信・パラメータ解析。
3. Azure Blob Storage の `movies` コンテナから `schedules.json` をロード。
4. 映画ID・日付でスケジュールをフィルタ。
5. スケジュール一覧を返却。

**エラー処理:**
- 該当スケジュールなしは空リスト返却。
- 映画ID/日付不正はエラー返却。

---

### 3. 座席予約

**フロー:**
1. MCPクライアントがスケジュールID・座席ID・ユーザー情報で予約リクエスト送信。
2. Azure Blob Storage の `movies` コンテナから `seats_schedules.json` で座席状態を確認。
3. 空席なら予約状態に変更（サンプルはメモリ更新、実運用はDB等）。
4. 予約確認を返却。

**エラー処理:**
- 既に予約済み座席はエラー返却。
- スケジュールID/座席ID不正はエラー返却。

---

### 4. あいまい入力対応

**フロー:**
1. MCPクライアントがあいまいな入力（例：映画名の誤字）を送信。
2. Azure Blob Storage の `movies` コンテナから `fuzzy-input.json` やNLPでマッチング。
3. 最適な映画・スケジュールを返却。

**エラー処理:**
- マッチなしはエラーまたは候補返却。

---

### 5. レコメンド

**フロー:**
1. MCPクライアントが履歴や好みに基づくレコメンドリクエスト送信。
2. Azure Blob Storage の `movies` コンテナから `recommendations.json` をロード。
3. 推薦映画・スケジュールを返却。

**エラー処理:**
- 推薦なしは空リスト返却。

---

### 6. ユーザー操作記録

**フロー:**
1. MCPクライアントが操作（検索・予約等）を記録リクエスト送信。
2. Azure Blob Storage の `movies` コンテナの `user-interactions.json` に追記（サンプルはメモリ、実運用は永続化）。
3. 成功ステータス返却。

**エラー処理:**
- 操作内容・パラメータ不正はエラー返却。

---

### 7. エラー報告

**フロー:**
1. MCPクライアントがエラー報告や詳細取得リクエスト送信。
2. Azure Blob Storage の `movies` コンテナから `error.json` をロード。
3. エラー詳細返却または記録。

**エラー処理:**
- エラーコード不正は標準化エラー返却。

---

## 11. Blobアクセス（get_snippet / save_snippet参照）

### Blob Storageアクセスフロー

- **get_snippet**
  1. スニペット名を指定してMCPクライアントがリクエスト送信。
  2. Azure Functionがスニペット名パラメータをバリデーション。
  3. Azure Functionsバインディング（推奨）またはAzure SDKでBlob Storageへアクセス。
  4. 指定名のBlobコンテンツ取得。
  5. JSON-RPCレスポンスで返却。

- **save_snippet**
  1. スニペット名・内容を指定してリクエスト送信。
  2. 両パラメータをバリデーション。
  3. バインディングまたはSDKでBlob Storageに保存。
  4. 成否ステータス返却。

**バリデーション:**
- 必須パラメータ（空・形式不正等）を必ず検証。
- 不正時は標準化エラー返却。

**セキュリティ:**
- 許可されたBlobコンテナのみアクセス。
- スニペット名はパストラバーサル・インジェクション防止でサニタイズ。

---

## 12. 予約データの保存

- MCP APIで予約作成時：
  1. スケジュールID・座席ID・ユーザー情報等リクエストパラメータをバリデーション。
  2. 有効かつ空席なら予約レコード作成。
3. Azure Blob Storage の `movies` コンテナ配下の `reservations.jsonl`（JSON List形式、1行1オブジェクト）に追記保存。
  4. 予約確認を返却。

**バリデーション:**
- 必須項目の有無・形式を検証。
- 重複・競合予約もチェック。

**エラー処理:**
- バリデーション失敗や空席なしはエラー返却。
